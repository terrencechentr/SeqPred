# 平滑窗口实验说明

## 概述

这个实验用于系统地分析不同平滑窗口大小对模型预测效果的影响。

## 实验设计

### 实验目的
- 找出最佳的平滑窗口大小
- 分析窗口大小与模型性能的关系
- 为生产环境提供参数选择建议

### 实验方法
1. **训练多个模型**：使用不同的平滑窗口大小
2. **统一评估标准**：所有模型使用相同的训练/测试数据和评估指标
3. **多维度对比**：从Loss、MAE、方向准确率、R²等多个角度分析
4. **可视化分析**：生成对比图表和详细报告

## 使用方法

### 基础用法

```bash
cd /SeqPred/scripts
python experiment_smooth_window.py
```

默认测试窗口大小：10, 20, 30, 50, 70, 100

### 自定义窗口大小

```bash
python experiment_smooth_window.py --window_sizes 5 10 20 40 80
```

### 启用数据集平滑（使用SpetDataset自带平滑）

```bash
# 启用数据集平滑，并让数据集平滑窗口与实验窗口保持一致
python experiment_smooth_window.py \
    --use_dataset_smoothing \
    --window_sizes 10 20 30 50

# 或者单独指定数据集平滑窗口（与模型窗口不同）
python experiment_smooth_window.py \
    --use_dataset_smoothing \
    --dataset_smooth_window_size 60 \
    --dataset_smooth_target_features 0 1 \
    --window_sizes 10 20 30 50
```

### 自定义训练轮数

```bash
python experiment_smooth_window.py --epochs 100
```

### 完整参数

```bash
python experiment_smooth_window.py \
    --window_sizes 10 20 30 50 70 100 \
    --epochs 50 \
    --output_dir ../experiments
```

## 实验输出

### 目录结构

```
experiments/smooth_window_exp_YYYYMMDD_HHMMSS/
├── window_10/
│   ├── best_model/              # 窗口=10的最佳模型
│   ├── training_curves.png      # 训练曲线
│   └── training_history.txt     # 训练历史
├── window_20/
│   ├── ...
├── ...
├── results.json                 # 原始结果（JSON格式）
├── results_summary.csv          # 结果汇总（CSV格式）
├── comparison_plots.png         # 对比图表 ⭐
└── analysis_report.txt          # 分析报告 ⭐
```

### 生成的文件

#### 1. comparison_plots.png（对比图表）

包含6个子图：
- **Test Loss vs Window Size**: 测试损失随窗口大小变化
- **MAE vs Window Size**: 平均绝对误差随窗口大小变化
- **Direction Accuracy vs Window Size**: 方向准确率随窗口大小变化
- **R² Score vs Window Size**: R²分数随窗口大小变化
- **Training Time vs Window Size**: 训练时间随窗口大小变化
- **Best Epoch vs Window Size**: 最佳Epoch随窗口大小变化

#### 2. analysis_report.txt（分析报告）

包含内容：
```
================================================================================
平滑窗口大小对预测效果的影响 - 实验报告
================================================================================

实验时间: 20251215_123456
测试窗口: [10, 20, 30, 50, 70, 100]
实验数量: 6

================================================================================
实验结果汇总
================================================================================

  Window | Test Loss  |    MAE   | Dir Acc  |    R²    | Best Epoch |  Time(s)
--------------------------------------------------------------------------------
      10 |   0.336216 |  0.0234  |  52.34%  |  0.6543  |         15 |    123.4
      20 |   0.298765 |  0.0198  |  54.67%  |  0.7012  |         18 |    145.2
     ...

================================================================================
关键发现
================================================================================

1. 最佳测试Loss窗口: 30
   - Test Loss: 0.287654

2. 最佳MAE窗口: 30
   - MAE: 0.0189

3. 最佳方向准确率窗口: 50
   - 方向准确率: 56.78%

================================================================================
统计分析
================================================================================

测试Loss:
  - 平均: 0.312345
  - 最小: 0.287654
  - 最大: 0.345678
  - 标准差: 0.023456

================================================================================
建议
================================================================================

1. 推荐使用窗口大小: 30
   理由: 获得了最低的测试Loss

2. 根据实验结果调整:
   - 如果需要更好的方向预测，选择方向准确率最高的窗口
   - 如果需要平衡性能和速度，考虑中等窗口大小
   - 如果数据噪声较大，可以尝试更大的窗口
```

#### 3. results_summary.csv（结果汇总）

可以导入Excel或Pandas进行进一步分析：
```csv
window_size,test_loss,mae,direction_accuracy,r2_score,best_epoch,train_time
10,0.336216,0.0234,52.34,0.6543,15,123.4
20,0.298765,0.0198,54.67,0.7012,18,145.2
...
```

## 评估指标说明

### 1. Test Loss（测试损失）
- **含义**: 模型在测试集上的MSE损失
- **越小越好**
- **重要性**: ⭐⭐⭐⭐⭐（最关键指标）

### 2. MAE（平均绝对误差）
- **含义**: |预测值 - 真实值| 的平均
- **越小越好**
- **重要性**: ⭐⭐⭐⭐

### 3. Direction Accuracy（方向准确率）
- **含义**: 预测涨跌方向的准确率
- **越高越好**（>50%有意义）
- **重要性**: ⭐⭐⭐⭐⭐（交易决策关键）

### 4. R² Score
- **含义**: 模型解释数据方差的比例
- **范围**: [-∞, 1]，越接近1越好
- **重要性**: ⭐⭐⭐

### 5. Training Time（训练时间）
- **含义**: 模型训练所需时间
- **越短越好**（但不是主要考虑因素）
- **重要性**: ⭐⭐

### 6. Best Epoch（最佳轮数）
- **含义**: 获得最佳测试Loss的轮数
- **参考**: 如果很小，可能需要调整模型复杂度
- **重要性**: ⭐⭐

## 实验结果解读

### 最佳窗口选择策略

#### 策略1：综合最优（推荐）
选择Test Loss最低的窗口大小。

#### 策略2：方向预测优先
如果主要关注交易方向，选择Direction Accuracy最高的窗口。

#### 策略3：稳定性优先
选择在多个指标上都表现均衡的窗口大小。

### 窗口大小的影响

#### 小窗口（<20）
- **优点**: 
  - 对短期波动敏感
  - 训练速度快
- **缺点**: 
  - 容易受噪声干扰
  - 可能过拟合

#### 中等窗口（20-50）
- **优点**: 
  - 平衡噪声和信号
  - 通常性能最佳
- **缺点**: 
  - 需要根据数据特性调整

#### 大窗口（>50）
- **优点**: 
  - 平滑噪声
  - 捕捉长期趋势
- **缺点**: 
  - 可能丢失短期信息
  - 反应较慢

## 实用技巧

### 1. 快速实验

测试少量窗口，快速定位最优范围：

```bash
python experiment_smooth_window.py \
    --window_sizes 10 30 50 \
    --epochs 30
```

### 2. 精细搜索

在最优范围内进行精细搜索：

```bash
# 假设30附近最优
python experiment_smooth_window.py \
    --window_sizes 25 28 30 32 35 \
    --epochs 50
```

### 3. 查看结果

```bash
# 查看报告
cat experiments/smooth_window_exp_*/analysis_report.txt

# 查看最佳窗口
grep "推荐使用窗口大小" experiments/smooth_window_exp_*/analysis_report.txt

# 在Python中分析
import pandas as pd
df = pd.read_csv('experiments/smooth_window_exp_YYYYMMDD_HHMMSS/results_summary.csv')
print(df.sort_values('best_test_loss'))
```

### 4. 对比多次实验

```bash
# 运行多次实验以验证结果稳定性
for i in {1..3}; do
    python experiment_smooth_window.py --window_sizes 20 30 40
    sleep 10
done
```

## 注意事项

1. **计算资源**: 每个模型需要训练50个epoch，总时间 = 窗口数量 × 单模型训练时间
2. **数据一致性**: 所有模型使用相同的训练/测试数据划分
3. **随机性**: 由于训练随机性，建议多次实验取平均
4. **过拟合**: 注意观察训练曲线，避免选择过拟合严重的窗口
5. **硬件限制**: 如果内存不足，减少窗口数量或batch_size

## 高级用法

### 修改实验参数

编辑脚本中的训练命令部分：

```python
cmd = [
    'python', '../train.py',
    '--model_type', 'csept_smooth',
    '--train_start', '3000',    # 修改这些参数
    '--train_end', '4000',
    '--test_start', '5000',
    '--test_end', '6000',
    '--epochs', str(epochs),
    '--batch_size', '32',       # 修改batch_size
    '--learning_rate', '0.0001', # 修改学习率
    # ...
]
```

### 添加更多评估指标

在`parse_evaluation_output`方法中添加新的指标解析。

## 示例输出

```
================================================================================
开始平滑窗口实验
实验目录: experiments/smooth_window_exp_20251215_123456
窗口大小: [10, 20, 30, 50, 70, 100]
================================================================================

================================================================================
训练模型 - 平滑窗口: 10
================================================================================

训练开始...
Epoch 1/50: Train Loss=1.046, Test Loss=0.336
Epoch 2/50: Train Loss=0.934, Test Loss=0.359
...
✓ 训练完成，耗时: 123.45秒

评估模型 - 平滑窗口: 10
✓ 评估完成
  - 测试Loss: 0.336216
  - MAE: 0.0234
  - 方向准确率: 52.34%

================================================================================
训练模型 - 平滑窗口: 20
================================================================================
...

✓ 结果保存到: experiments/smooth_window_exp_20251215_123456/results.json

================================================================================
生成分析报告
================================================================================

✓ CSV保存到: experiments/smooth_window_exp_20251215_123456/results_summary.csv
✓ 对比图保存到: experiments/smooth_window_exp_20251215_123456/comparison_plots.png
✓ 分析报告保存到: experiments/smooth_window_exp_20251215_123456/analysis_report.txt

================================================================================
实验结果简要
================================================================================

🏆 最佳窗口大小: 30
   - Test Loss: 0.287654
   - MAE: 0.0189
   - 方向准确率: 55.67%

================================================================================
实验完成！
结果目录: experiments/smooth_window_exp_20251215_123456
================================================================================
```

## 故障排除

### 问题1: 训练失败
**现象**: 某个窗口的训练失败
**解决**: 检查错误信息，可能是参数设置不当或数据问题

### 问题2: 内存不足
**现象**: OOM错误
**解决**: 
```bash
# 减少batch_size或减少窗口数量
python experiment_smooth_window.py --window_sizes 10 30 50
```

### 问题3: 评估失败
**现象**: 模型训练成功但评估失败
**解决**: 检查模型保存路径和评估脚本

## 相关文档

- [训练脚本使用说明](scripts/README.md)
- [评估改进说明](EVALUATION_IMPROVEMENTS.md)
- [训练可视化说明](TRAINING_VISUALIZATION.md)
- [价格恢复功能说明](PRICE_RECOVERY_FEATURE.md)

